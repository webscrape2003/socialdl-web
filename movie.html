<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<title>Vajira Movie Box – Full Combined</title>
<link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;600;800&display=swap" rel="stylesheet">

<style>
:root { 
    --primary: #ff1e2a; 
    --primary-glow: rgba(255, 30, 42, 0.4);
    --bg: #0a0a0a; 
    --card: #121212; 
    --text: #ffffff; 
    --accent: #38bdf8; 
}
body { background-color: var(--bg); color: var(--text); font-family: 'Plus Jakarta Sans', sans-serif; margin: 0; }

/* ===== SEARCH PAGE ===== */
.header { padding: 20px; background: #000; border-bottom: 1px solid #222; position: sticky; top: 0; z-index: 1000; }
.search-box { max-width: 600px; margin: 0 auto; display: flex; gap: 10px; background: #1a1a1a; padding: 5px; border-radius: 12px; border: 1px solid #333; }
.search-box input { flex: 1; background: transparent; border: none; color: white; padding: 12px; outline: none; }
.search-box button { background: var(--primary); color: white; border: none; padding: 0 20px; border-radius: 8px; font-weight: 700; cursor: pointer; }
.container { max-width: 1200px; margin: 30px auto; padding: 0 15px; }
.section-title { font-size: 1.4rem; font-weight: 800; margin-bottom: 25px; color: #fff; border-left: 5px solid var(--primary); padding-left: 15px; }
.movie-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(180px, 1fr)); gap: 20px; }
.movie-card { background: var(--card); border-radius: 12px; overflow: hidden; transition: 0.3s; cursor: pointer; border: 1px solid #222; position: relative; display: flex; flex-direction: column; }
.movie-card:hover { transform: translateY(-8px); border-color: var(--primary); }
.image-container { position: relative; width: 100%; padding-top: 145%; background: #1a1a1a; }
.movie-card img { position: absolute; inset: 0; width: 100%; height: 100%; object-fit: cover; }
.card-info { padding: 15px; background: linear-gradient(to top, #000 85%, transparent); margin-top: -70px; }
.card-title { font-size: 0.85rem; text-align: center; }

/* ===== DETAIL PAGE (UNCHANGED DESIGN) ===== */
#detailPage { display:none; }

.url-header {
    padding: 20px;
    background: rgba(13, 13, 13, 0.8);
    backdrop-filter: blur(15px);
    border-bottom: 1px solid #222;
    position: sticky; top: 0; z-index: 1000;
}
.input-group {
    max-width: 800px; margin: 0 auto;
    display: flex; gap: 10px; background: #000;
    padding: 5px; border-radius: 12px; border: 1px solid #333;
}
#urlInput { flex: 1; background: transparent; border: none; color: white; padding: 10px 15px; outline: none; }
#fetchBtn { background: var(--primary); color: white; border: none; padding: 0 25px; border-radius: 8px; font-weight: 800; cursor: pointer; }

.movie-main { display: grid; grid-template-columns: 300px 1fr; gap: 40px; margin-bottom: 50px; }
.poster { width: 100%; border-radius: 15px; border: 1px solid #333; }
.download-card { background: #0f0f0f; border-radius: 20px; padding: 30px; border: 1px solid #222; }
.dl-row { display:flex; justify-content:space-between; align-items:center; padding:15px; border-bottom:1px solid #222; }
.dl-action-btn { background:#111; border:1px solid #333; color:#fff; padding:10px 18px; border-radius:10px; cursor:pointer; }
</style>
</head>

<body>

<!-- ================= SEARCH PAGE ================= -->
<div id="searchPage">
    <div class="header">
        <div class="search-box">
            <input type="text" id="searchInput" placeholder="Search Movie or Year...">
            <button id="searchBtn" onclick="searchMovies()">SEARCH</button>
        </div>
    </div>

    <div class="container">
        <div class="section-title" id="statusText">Latest Movies</div>
        <div id="loading" style="display:none; text-align:center; padding: 40px; color: var(--primary); font-weight: bold;">Connecting to Server...</div>
        <div class="movie-grid" id="movieGrid"></div>
    </div>
</div>

<!-- ================= DETAIL PAGE ================= -->
<div id="detailPage">
    <div class="url-header">
        <div class="input-group">
            <button onclick="goBack()" style="background:#222;color:#fff;border:none;padding:0 20px;border-radius:8px;">← Back</button>
            <input type="text" id="urlInput" placeholder="Paste movie link here...">
            <button id="fetchBtn" onclick="fetchMovieDetails()">GET MOVIE</button>
        </div>
    </div>
    <div class="container" id="mainDisplay"></div>
</div>

<script>
const apikey = "vajiraofficial";
const proxy = "https://api.allorigins.win/get?url=";

async function fetchWithRetry(url, retries = 3) {
    for (let i = 0; i < retries; i++) {
        try {
            const response = await fetch(proxy + encodeURIComponent(url));
            if (!response.ok) throw new Error('Network fail');
            return await response.json();
        } catch (err) {
            if (i === retries - 1) throw err;
            await new Promise(res => setTimeout(res, 1000));
        }
    }
}

async function searchMovies() {
    const query = document.getElementById('searchInput').value.trim();
    const grid = document.getElementById('movieGrid');
    const status = document.getElementById('statusText');
    const loader = document.getElementById('loading');
    if (!query) return;

    grid.innerHTML = '';
    loader.style.display = 'block';
    status.innerText = `Searching for: ${query}`;

    const searchUrl = `https://vajira-mv-apikeys.netlify.app/api/pirate/search?q=${encodeURIComponent(query)}&apikey=${apikey}`;

    try {
        const jsonWrapper = await fetchWithRetry(searchUrl);
        const result = JSON.parse(jsonWrapper.contents);
        const moviesArray = result?.data?.data?.data || [];

        loader.style.display = 'none';

        status.innerText = `Results for: ${query}`;
        grid.innerHTML = moviesArray.map(movie => `
            <div class="movie-card" onclick="openDetails('${movie.link}')">
                <div class="image-container">
                    <img src="${movie.imageSrc || movie.image}">
                </div>
                <div class="card-info">
                    <div class="card-title">${movie.title}</div>
                </div>
            </div>
        `).join('');
    } catch (e) {
        loader.style.display = 'none';
        status.innerText = "Connection Error";
    }
}

function openDetails(url) {
    document.getElementById('searchPage').style.display = 'none';
    document.getElementById('detailPage').style.display = 'block';
    document.getElementById('urlInput').value = url;
    fetchMovieDetails();
}

function goBack() {
    document.getElementById('detailPage').style.display = 'none';
    document.getElementById('searchPage').style.display = 'block';
}

async function fetchMovieDetails() {
    const movieUrl = document.getElementById('urlInput').value.trim();
    if (!movieUrl) return;

    const container = document.getElementById('mainDisplay');
    container.innerHTML = '<div style="text-align:center; padding:100px;">Analyzing metadata...</div>';

    const apiUrl = `https://vajira-mv-apikeys.netlify.app/api/pirate/movie?url=${encodeURIComponent(movieUrl)}&apikey=${apikey}`;

    try {
        const resp = await fetch(proxy + encodeURIComponent(apiUrl));
        const jsonWrapper = await resp.json();
        const result = JSON.parse(jsonWrapper.contents);

        const movie = result.data.data.mainDetails;
        const extra = result.data.data.moviedata;
        const links = result.data.data.dllinks.directDownloadLinks;

        container.innerHTML = `
            <div class="movie-main">
                <img src="${movie.imageUrl}" class="poster">
                <div>
                    <h1>${movie.maintitle}</h1>
                    <p>${extra.description}</p>
                </div>
            </div>

            <div class="download-card">
                ${links.map(l => `
                    <div class="dl-row">
                        <b>${l.quality}</b>
                        <button class="dl-action-btn" onclick="window.open('${l.link}','_blank')">Download</button>
                    </div>
                `).join('')}
            </div>
        `;
    } catch (e) {
        container.innerHTML = '<div style="text-align:center;color:red;padding:100px;">Failed to fetch data.</div>';
    }
}
</script>

</body>
</html>
